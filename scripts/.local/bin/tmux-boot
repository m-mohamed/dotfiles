#!/bin/bash
# tmux-boot - Bootstrap Claude Code sessions with Git repo auto-discovery
#
# Usage:
#   tmux-boot           # Interactive fuzzy picker
#   tmux-boot --all     # Boot all discovered repos
#   tmux-boot --list    # List discovered repos
#
# Dependencies: fd, gum, tmux, zoxide (optional, for frecency sorting)
#
set -euo pipefail

# Directories to scan for Git repos (customize as needed)
SEARCH_DIRS=(~/startups ~/projects ~/code ~/work ~/dotfiles)

# Styling (Tokyo Night theme)
export GUM_FILTER_INDICATOR_FOREGROUND="#7aa2f7"
export GUM_FILTER_MATCH_FOREGROUND="#9ece6a"
export GUM_FILTER_HEADER_FOREGROUND="#bb9af7"
export GUM_FILTER_PROMPT_FOREGROUND="#bb9af7"
export GUM_FILTER_CURSOR_TEXT_FOREGROUND="#7aa2f7"
export GUM_CHOOSE_CURSOR_FOREGROUND="#7aa2f7"
export GUM_CHOOSE_SELECTED_FOREGROUND="#9ece6a"
export GUM_CHOOSE_HEADER_FOREGROUND="#bb9af7"

# Check dependencies
check_deps() {
  local missing=()
  command -v fd &>/dev/null || missing+=("fd")
  command -v gum &>/dev/null || missing+=("gum")
  command -v tmux &>/dev/null || missing+=("tmux")

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Missing dependencies: ${missing[*]}"
    echo "Install with: brew install ${missing[*]}"
    exit 1
  fi
}

# Discover Git repositories in configured directories
# Max depth of 4 covers: ~/projects/category/project/.git
discover_repos() {
  local dirs=()
  for dir in "${SEARCH_DIRS[@]}"; do
    local expanded="${dir/#\~/$HOME}"
    [[ -d "$expanded" ]] && dirs+=("$expanded")
  done

  [[ ${#dirs[@]} -eq 0 ]] && return

  fd -t d "^\.git$" "${dirs[@]}" --hidden --max-depth 4 2>/dev/null | while read -r git_dir; do
    dirname "$git_dir"
  done | sort -u
}

# Get projects sorted by zoxide frecency (fallback to alphabetical)
# Output format: name|path
get_sorted_projects() {
  local repos
  repos=$(discover_repos)

  [[ -z "$repos" ]] && return

  if command -v zoxide &>/dev/null; then
    # Get zoxide scores and join with discovered repos in one awk pass
    # Input: zoxide scores first (marked with Z:), then repos (marked with R:)
    {
      zoxide query --list --score 2>/dev/null | sed 's/^/Z:/' || true
      echo "$repos" | sed 's/^/R:/'
    } | awk '
    BEGIN { FS=" " }
    /^Z:/ {
      # Parse zoxide line: "Z:  SCORE /path"
      sub(/^Z:[[:space:]]*/, "")
      score = $1
      $1 = ""
      gsub(/^[[:space:]]+/, "")
      path = $0
      if (path != "") scores[path] = score
    }
    /^R:/ {
      # Parse repo line: "R:/path"
      sub(/^R:/, "")
      path = $0
      repos[path] = 1
    }
    END {
      for (path in repos) {
        score = (path in scores) ? scores[path] : 0
        n = split(path, parts, "/")
        name = parts[n]
        print score "|" name "|" path
      }
    }' | sort -t'|' -k1 -rn | cut -d'|' -f2-
  else
    echo "$repos" | awk -F/ '{print $NF "|" $0}' | sort
  fi
}

# List projects
list_projects() {
  echo "Discovered Git repositories:"
  echo ""
  local projects
  projects=$(get_sorted_projects)

  if [[ -z "$projects" ]]; then
    echo "  No Git repositories found in:"
    for dir in "${SEARCH_DIRS[@]}"; do
      echo "    $dir"
    done
    return 1
  fi

  while IFS='|' read -r name path; do
    printf "  %-20s %s\n" "$name" "$path"
  done <<< "$projects"
}

# Boot a single project by name|path format
boot_project() {
  local name="$1"
  local path="$2"

  # Check if session already exists
  if tmux has-session -t "$name" 2>/dev/null; then
    echo "Session '$name' exists, switching..."
    # If inside tmux, switch; otherwise attach
    if [[ -n "${TMUX:-}" ]]; then
      tmux switch-client -t "$name"
    else
      tmux attach -t "$name"
    fi
  else
    echo "Creating session '$name' in $path..."
    tmux new-session -d -s "$name" -c "$path"
    tmux send-keys -t "$name" "claude" Enter
    # If inside tmux, switch; otherwise attach
    if [[ -n "${TMUX:-}" ]]; then
      tmux switch-client -t "$name"
    else
      tmux attach -t "$name"
    fi
  fi
}

# Lookup path for a given project name from the projects list
lookup_path() {
  local target_name="$1"
  local projects="$2"

  while IFS='|' read -r name path; do
    if [[ "$name" == "$target_name" ]]; then
      echo "$path"
      return 0
    fi
  done <<< "$projects"
  return 1
}

# Main
main() {
  check_deps

  # Handle flags
  case "${1:-}" in
    --all)
      echo "Booting all discovered repos..."
      local projects
      projects=$(get_sorted_projects)

      if [[ -z "$projects" ]]; then
        echo "No Git repositories found"
        exit 1
      fi

      while IFS='|' read -r name path; do
        boot_project "$name" "$path"
        sleep 0.5  # Brief delay to let session initialize
      done <<< "$projects"
      echo ""
      echo "Done! Use Ctrl+a w for session chooser"
      ;;
    --list)
      list_projects
      ;;
    --help|-h)
      echo "Usage: tmux-boot [--all|--list|--help]"
      echo ""
      echo "  (no args)  Interactive fuzzy picker"
      echo "  --all      Boot all discovered repos"
      echo "  --list     List discovered repos"
      echo ""
      echo "Scans for Git repos in:"
      for dir in "${SEARCH_DIRS[@]}"; do
        echo "  $dir"
      done
      ;;
    *)
      # Interactive fuzzy selection
      local projects
      projects=$(get_sorted_projects)

      if [[ -z "$projects" ]]; then
        echo "No Git repositories found in configured directories"
        echo "Edit SEARCH_DIRS in this script to add more paths"
        exit 1
      fi

      # Extract names for display
      local names
      names=$(echo "$projects" | cut -d'|' -f1)

      local selected
      selected=$(echo "$names" | gum filter \
        --no-limit \
        --height=15 \
        --header "Select projects (Tab=multi, Enter=confirm):" \
        --placeholder "Type to filter...")

      if [[ -z "$selected" ]]; then
        echo "No projects selected"
        exit 0
      fi

      while IFS= read -r name; do
        local path
        path=$(lookup_path "$name" "$projects")
        if [[ -n "$path" ]]; then
          boot_project "$name" "$path"
          sleep 0.5
        fi
      done <<< "$selected"

      echo ""
      echo "Done! Use Ctrl+a w for session chooser"
      ;;
  esac
}

main "$@"
