#!/bin/bash
# wez-boot - Bootstrap Claude Code workspaces with interactive selection
#
# Usage:
#   wez-boot           # Interactive multi-select
#   wez-boot --all     # Boot all projects
#   wez-boot --list    # List available projects
#
# Dependencies: jq, gum, wezterm, zoxide (optional)
#
set -euo pipefail

PROJECTS_JSON="${XDG_CONFIG_HOME:-$HOME/.config}/claude-hooks/projects.json"

# Styling (Tokyo Night theme to match WezTerm)
export GUM_CHOOSE_CURSOR_FOREGROUND="#7aa2f7"
export GUM_CHOOSE_SELECTED_FOREGROUND="#9ece6a"
export GUM_CHOOSE_HEADER_FOREGROUND="#bb9af7"

# Check dependencies
check_deps() {
  local missing=()
  command -v jq &>/dev/null || missing+=("jq")
  command -v gum &>/dev/null || missing+=("gum")
  command -v wezterm &>/dev/null || missing+=("wezterm")

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Missing dependencies: ${missing[*]}"
    echo "Install with: brew install ${missing[*]}"
    exit 1
  fi

  if [[ ! -f "$PROJECTS_JSON" ]]; then
    echo "Projects config not found: $PROJECTS_JSON"
    echo "Run: stow claude-hooks (from ~/dotfiles)"
    exit 1
  fi
}

# Get projects sorted by zoxide frecency (fallback to priority)
get_sorted_projects() {
  if command -v zoxide &>/dev/null; then
    # Query zoxide for frecency scores, merge with projects.json
    while IFS= read -r path; do
      local expanded="${path/#\~/$HOME}"
      local score
      score=$(zoxide query --score "$expanded" 2>/dev/null | awk '{print $1}' || echo "0")
      local name
      name=$(jq -r ".[] | select(.path == \"$path\") | .name" "$PROJECTS_JSON")
      echo "$score $name"
    done < <(jq -r '.[].path' "$PROJECTS_JSON") | sort -rn | awk '{print $2}'
  else
    # Fallback to priority ordering
    jq -r 'sort_by(.priority) | .[].name' "$PROJECTS_JSON"
  fi
}

# List projects
list_projects() {
  echo "Available projects:"
  jq -r '.[] | "  \(.name)\t\(.path)"' "$PROJECTS_JSON" | column -t -s $'\t'
}

# Boot a single project
boot_project() {
  local name="$1"
  local project
  project=$(jq -r ".[] | select(.name == \"$name\")" "$PROJECTS_JSON")

  if [[ -z "$project" ]]; then
    echo "Project not found: $name"
    return 1
  fi

  local path
  path=$(echo "$project" | jq -r '.path' | sed "s|~|$HOME|")

  # Check if workspace already exists
  if wezterm cli list --format json 2>/dev/null | jq -e ".[] | select(.workspace == \"$name\")" &>/dev/null; then
    echo "Workspace '$name' already exists, switching..."
    # Get pane ID and activate it
    local pane_id
    pane_id=$(wezterm cli list --format json | jq -r ".[] | select(.workspace == \"$name\") | .pane_id" | head -1)
    wezterm cli activate-pane --pane-id "$pane_id"
  else
    echo "Creating workspace '$name' in $path..."
    wezterm cli spawn --new-window --workspace "$name" --cwd "$path" -- claude
  fi
}

# Main
main() {
  check_deps

  # Handle flags
  case "${1:-}" in
    --all)
      echo "Booting all projects..."
      while IFS= read -r name; do
        boot_project "$name"
        sleep 0.5  # Brief delay to let workspace initialize
      done < <(get_sorted_projects)
      echo ""
      echo "Done! Use Leader+G for dashboard, Leader+w for workspace switcher"
      ;;
    --list)
      list_projects
      ;;
    --help|-h)
      echo "Usage: wez-boot [--all|--list|--help]"
      echo ""
      echo "  (no args)  Interactive multi-select"
      echo "  --all      Boot all projects"
      echo "  --list     List available projects"
      ;;
    *)
      # Interactive selection
      local names
      names=$(get_sorted_projects)

      if [[ -z "$names" ]]; then
        echo "No projects found in $PROJECTS_JSON"
        exit 1
      fi

      local selected
      selected=$(echo "$names" | gum choose --no-limit --header "Select projects to boot (Tab to select, Enter to confirm):")

      if [[ -z "$selected" ]]; then
        echo "No projects selected"
        exit 0
      fi

      while IFS= read -r name; do
        boot_project "$name"
        sleep 0.5
      done <<< "$selected"

      echo ""
      echo "Done! Use Leader+G for dashboard, Leader+w for workspace switcher"
      ;;
  esac
}

main "$@"
