# ══════════════════════════════════════════════════════════════════════════════
# TMUX.CONF - Modern Best Practices 2025
# Tokyo Night theme | Claude Code optimized | Popup terminals
# ══════════════════════════════════════════════════════════════════════════════

# ─── Core Settings ────────────────────────────────────────────────────────────
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"           # True color support
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'  # Cursor shape (vim)
set -g escape-time 0                                 # No ESC delay (vim-critical)
set -g history-limit 50000                           # Large scrollback
set -g focus-events on                               # Pass focus events to vim
set -g mouse on                                      # Mouse support
set -g base-index 1                                  # Windows start at 1
setw -g pane-base-index 1                            # Panes start at 1
set -g renumber-windows on                           # Renumber on close
set -g set-clipboard on                              # OSC 52 clipboard
set -g display-time 2000                             # Message display time
set -g display-panes-time 2000                       # Pane numbers display time
set -g status-interval 5                             # Status refresh interval

# ─── Prefix Key (Ctrl+a like Screen) ──────────────────────────────────────────
unbind C-b
set -g prefix C-a
bind C-a send-prefix                                 # Send Ctrl+a to apps

# ─── Pane Navigation (Vim-style with prefix) ──────────────────────────────────
# Unbind defaults to ensure clean bindings
unbind h
unbind j
unbind k
unbind l
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Smart pane switching with vim awareness (no plugin needed)
# Uses shell check instead of vim-tmux-navigator plugin to avoid lag
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# ─── Pane Management ──────────────────────────────────────────────────────────
bind s split-window -v -c "#{pane_current_path}"     # Horizontal split
bind v split-window -h -c "#{pane_current_path}"     # Vertical split
bind z resize-pane -Z                                 # Zoom toggle
bind q confirm-before -p "Kill pane #P? (y/n)" kill-pane
bind x confirm-before -p "Kill pane #P? (y/n)" kill-pane

# Resize panes (repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# ─── Window Management ────────────────────────────────────────────────────────
bind t new-window -c "#{pane_current_path}"          # New window
bind [ previous-window
bind ] next-window
bind Tab last-window                                  # Toggle last window
bind r command-prompt -I "#W" "rename-window '%%'"
bind c confirm-before -p "Kill window #W? (y/n)" kill-window

# Move windows (repeatable)
bind -r , swap-window -t -1\; select-window -t -1
bind -r . swap-window -t +1\; select-window -t +1

# Direct window access (no prefix, for mobile)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ─── Session Management ───────────────────────────────────────────────────────
bind w choose-tree -Zs                               # Session/window chooser
bind R command-prompt -I "#S" "rename-session '%%'"
bind d detach-client
bind D choose-client -Z                              # Detach other clients

# ─── Modern Popup Features (tmux 3.2+) ────────────────────────────────────────
# Session switcher popup with tmux-boot (preview, delete, repos)
bind C-w display-popup -E -w 80% -h 80% "tmux-boot"

# Scratch terminal (persistent across sessions)
bind C-t display-popup -E -w 80% -h 80% -d "#{pane_current_path}" \
    "tmux new-session -A -s scratch"

# Quick command popup
bind C-p display-popup -E -w 60% -h 40% -d "#{pane_current_path}"

# Floating lazygit (if installed)
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" \
    "lazygit 2>/dev/null || echo 'lazygit not installed' && sleep 2"

# ─── Copy Mode (Vi-style) ─────────────────────────────────────────────────────
setw -g mode-keys vi
bind Enter copy-mode                                  # Enter copy mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle    # Rectangle selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Mouse selection copies to clipboard
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# ─── Reload Config ────────────────────────────────────────────────────────────
bind C-r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# ─── Tokyo Night Theme ────────────────────────────────────────────────────────
# Palette
bg="#1a1b26"
fg="#c0caf5"
blue="#7aa2f7"
green="#9ece6a"
purple="#bb9af7"
cyan="#7dcfff"
red="#f7768e"
yellow="#e0af68"
dark="#292e42"
darker="#1f2335"

# Status bar
set -g status-position bottom
set -g status-style "bg=$bg fg=$fg"
set -g status-left "#[fg=$blue,bold][#S] "
set -g status-left-length 25
set -g status-right "#[fg=$cyan]#{?client_prefix, PREFIX ,}#[fg=$green]%H:%M #[fg=$purple]%d-%b"
set -g status-right-length 50

# Window status
setw -g window-status-current-style "fg=$bg bg=$blue bold"
setw -g window-status-current-format " #I:#W#{?window_zoomed_flag,+,} "
setw -g window-status-style "fg=$fg bg=$dark"
setw -g window-status-format " #I:#W "
setw -g window-status-activity-style "fg=$yellow"
setw -g window-status-bell-style "fg=$red"
setw -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=$dark"
set -g pane-active-border-style "fg=$blue"
set -g pane-border-indicators colour                 # Just color, not arrows

# Messages and mode
set -g message-style "fg=$blue bg=$darker"
set -g message-command-style "fg=$yellow bg=$darker"
setw -g mode-style "fg=$bg bg=$blue"

# Popup styling (tmux 3.2+)
set -g popup-border-style "fg=$blue"
set -g popup-border-lines rounded

# ─── Activity & Bells ─────────────────────────────────────────────────────────
set -g monitor-activity on
set -g visual-activity off                           # Don't flash
set -g visual-bell off
set -g bell-action none

# ─── Plugins (TPM) ────────────────────────────────────────────────────────────
# Install TPM: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Then: prefix + I to install plugins

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'          # Sensible defaults
set -g @plugin 'tmux-plugins/tmux-resurrect'         # Session persistence
set -g @plugin 'tmux-plugins/tmux-continuum'         # Auto-save sessions
set -g @plugin 'tmux-plugins/tmux-yank'              # Clipboard integration

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum settings (auto-save every 15 min, auto-restore on start)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Initialize TPM (keep at bottom of file)
run '~/.tmux/plugins/tpm/tpm'
